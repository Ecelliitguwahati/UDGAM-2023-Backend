(()=>{var e={96:e=>{"use strict";e.exports=require("bcrypt")},582:e=>{"use strict";e.exports=require("cors")},142:e=>{"use strict";e.exports=require("dotenv")},860:e=>{"use strict";e.exports=require("express")},344:e=>{"use strict";e.exports=require("jsonwebtoken")},13:e=>{"use strict";e.exports=require("mongodb")},185:e=>{"use strict";e.exports=require("mongoose")},184:e=>{"use strict";e.exports=require("nodemailer")},871:e=>{"use strict";e.exports=require("razorpay")},828:e=>{"use strict";e.exports=require("uuid")}},s={};function o(r){var t=s[r];if(void 0!==t)return t.exports;var n=s[r]={exports:{}};return e[r](n,n.exports,o),n.exports}(()=>{const e=process.env.PORT||5e3,s=o(860),r=s(),{mongoClient:t,MongoClient:n}=o(13),{v4:a}=o(828),c=(o(344),o(96)),i=o(582),l=o(871),u=o(185);var d=o(184);o(142).config(),console.log(process.env.URI);const p=process.env.URI;r.use(s.json()),u.connect(p,{useNewUrlParser:!0,useUnifiedTopology:!0}).then((()=>{console.log("Connected to database ")})).catch((e=>{console.error(`Error connecting to the database. \n${e}`)})),r.use(i()),r.use(s.json({exrended:!1})),r.get("/",((e,s)=>{s.json("hello this is raj")}));const g=new u.Schema({isPaid:Boolean,amount:Number,razorpay:{orderId:String,paymentId:String,signature:String}}),m=u.model("Order",g);r.get("get-razorpay-key",((e,s)=>{s.send({key:process.env.RAZORPAY_KEY_ID})})),r.get("/get-razorpay-key",((e,s)=>{s.send({key:process.env.RAZORPAY_KEY_ID})})),r.post("/create-order",(async(e,s)=>{try{console.log("I am here");const o=new l({key_id:process.env.RAZORPAY_KEY_ID,key_secret:process.env.RAZORPAY_SECRET}),r={amount:e.body.amount,currency:"INR"},t=await o.orders.create(r);if(!t)return s.status(500).send("Some error occured");s.send(t)}catch(e){console.log(e),s.status(500).send(e)}})),r.post("/pay-order",(async(e,s)=>{try{const{amount:o,razorpayPaymentId:r,razorpayOrderId:t,razorpaySignature:n}=e.body,a=m({isPaid:!0,amount:o,razorpay:{orderId:t,paymentId:r,signature:n}});await a.save(),s.send({msg:"Payment was successfull"})}catch(e){console.log(e),s.status(500).send(e)}})),r.post("/registersave",(async(e,s)=>{console.log("I am here registering");const o=new n(p),{lastName:r,firstName:t,outlook:i,rollNo:l,email:u,password:d}=e.body;o.connect();const g=o.db("app-data").collection("usersData");try{const e=await g.findOne({email:u});console.log(e),e&&(console.log("user already exists"),s.status(201).send({message:"You had already purchased the UDGAM Pass. Still you will be mailed for the same."}))}catch(e){return console.log(e),s.status(500).send({message:e.message})}const m=a();c.genSalt(10,(function(e,o){c.hash(d,o,(async function(e,o){try{const e={user_id:m,firstName:t,lastName:r,outlook:i,rollno:l,email:u,hashedPassword:o};await g.insertOne(e),s.status(201).json({userId:m})}catch(e){return s.status(500).send({message:e.message})}}))}))})),r.post("/checkifpurchased",(async(e,s)=>{console.log("I am here checking");const o=new n(p),{email:r}=e.body;o.connect();const t=o.db("app-data").collection("usersData");try{const e=await t.findOne({email:r});console.log(e),e?(console.log("user already exists"),s.status(201).send({message:"YES"})):s.status(201).send({message:"NO"})}catch(e){return console.log(e),s.status(500).send({message:e.message})}}));var y=d.createTransport({service:"outlook",secureConnection:!1,port:587,tls:{ciphers:"SSLv3"},auth:{user:process.env.USEREMAIL,pass:process.env.USERPASSWORD}});r.post("/mailpass",(async(e,s)=>{console.log("I am here checking");const o=new n(p),{email:r}=e.body;o.connect();const t=o.db("app-data").collection("usersData");try{const e=await t.findOne({email:r});if(console.log(e),e){var a={from:`UDGAM 2023 <${process.env.USEREMAIL}>`,to:e.email,subject:"Welcome to UDGAM 2023",html:`Hi ${e.firstName},\n              <br><br>\n              Thanks for registering for UDGAM and purchasing the pass!\n              <br>\n              Here is your pass credentials<br>\n              <b>Email- ${r}</b><br>\n              <b>Unique ID- </b><br><br>\n              Regards,<br>\n              UDGAM Web Operations`};y.sendMail(a,(function(e,o){e&&s.status(500).send({message:e}),s.status(201).send({message:"YES"})}))}else s.status(201).send({message:"NO"})}catch(e){return console.log(e),s.status(500).send({message:e.message})}})),r.listen(e,(()=>{console.log("server is running on port "+e)}))})()})();